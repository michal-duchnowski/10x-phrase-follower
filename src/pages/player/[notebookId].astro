---
import Layout from "../../layouts/AppLayout.astro";
import PlayerShell from "../../components/PlayerShell.tsx";
import AuthGuard from "../../components/AuthGuard.tsx";

export const prerender = false;

// Get notebook ID from params
const { notebookId } = Astro.params;
const startPhraseId = Astro.url.searchParams.get("start_phrase_id");
const difficulty = Astro.url.searchParams.get("difficulty");
const phraseIdsParam = Astro.url.searchParams.get("phrase_ids");
const phraseIds = phraseIdsParam ? phraseIdsParam.split(",") : undefined;

// Validate notebook ID format (UUID or virtual notebook ID)
const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
const virtualNotebookRegex = /^difficulty-(easy|medium|hard)$/;
if (!notebookId || (!uuidRegex.test(notebookId) && !virtualNotebookRegex.test(notebookId))) {
  return Astro.redirect("/notebooks");
}

// Validate start_phrase_id if provided
if (startPhraseId && !uuidRegex.test(startPhraseId)) {
  return Astro.redirect(`/player/${notebookId}`);
}

// Note: We skip server-side notebook verification here because:
// 1. The Authorization header isn't available during SSR for client-side auth
// 2. The client-side PlayerShell component will handle authentication and error display
// 3. RLS policies will enforce access control when the API is called
---

<Layout title="Player - Phrase Follower" fullWidth={true}>
  <main class="min-h-screen">
    <AuthGuard client:load>
      <PlayerShell
        notebookId={notebookId}
        startPhraseId={startPhraseId || undefined}
        difficultyFilter={difficulty || undefined}
        phraseIds={phraseIds}
        client:load
      />
    </AuthGuard>
  </main>
</Layout>
